{% extends 'user/user_index.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Payment for {{ booking.service.name }}</h2>
    <p>Please complete your payment to confirm your booking.</p>

    <form method="post" id="paymentForm" autocomplete="off">
        {% csrf_token %}
        <div class="mb-3">
            <label for="amount" class="form-label">Amount to be Paid (50% of Service Price)</label>
            <input type="text" class="form-control" value="{{ amount|floatformat:2 }}" readonly>
        </div>

        <div class="mb-3">
            <label for="cardholder_name" class="form-label">Cardholder Name</label>
            <input type="text" name="cardholder_name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="card_number" class="form-label">Card Number</label>
            <input type="text" name="card_number_masked" id="card_number_masked" class="form-control" maxlength="19" minlength="19" required pattern="\*{12}\d{4}">
            <input type="hidden" name="card_number" id="card_number" required>
            <small class="text-muted">Enter 16 digits; only last 4 will be saved/visible.</small>
        </div>

        <div class="mb-3">
            <label for="cvv" class="form-label">CVV</label>
            <input type="text" name="cvv" class="form-control" maxlength="3" minlength="3" required pattern="\d{3}">
        </div>

        <div class="mb-3">
            <label for="expiry_date" class="form-label">Expiry Date (MM/YY)</label>
            <input type="text" name="expiry_date" id="expiry_date" class="form-control" placeholder="MM/YY" required pattern="(0[1-9]|1[0-2])\/\d{2}">
            <small class="text-muted">Enter a future expiry date.</small>
        </div>

        <button type="submit" class="btn btn-primary">Pay Now</button>
    </form>
</div>

<script>
    // Card number masking and storage
    let rawCardNumber = "";

    const maskedInput = document.getElementById("card_number_masked");
    const hiddenInput = document.getElementById("card_number");

    maskedInput.addEventListener("input", function(e) {
        // Only allow digits, and keep max 16 digits
        let digits = (rawCardNumber + e.data)?.replace(/\D/g, "") || maskedInput.value.replace(/\D/g, "");
        if (digits.length > 16) digits = digits.slice(0, 16);
        rawCardNumber = digits;

        // Mask input if length >= 12, else show as entered
        if (digits.length >= 4) {
            let masked = "*".repeat(Math.max(0, digits.length - 4)) + digits.slice(-4);
            // Format as 16 chars (always show 12 stars + 4 digits for 16 total)
            masked = masked.padStart(16, '*');
            maskedInput.value = masked;
        } else {
            maskedInput.value = digits;
        }

        // Update hidden field with actual value
        hiddenInput.value = digits;
    });

    maskedInput.addEventListener("keydown", function(e) {
        // Handle backspace correctly
        if (e.key === "Backspace") {
            rawCardNumber = rawCardNumber.slice(0, -1);
        }
    });

    document.getElementById("paymentForm").addEventListener("submit", function (e) {
        // Validate card number (must be exactly 16 digits)
        const digits = hiddenInput.value;
        if (!/^\d{16}$/.test(digits)) {
            alert("Card number must be exactly 16 digits.");
            e.preventDefault();
            return;
        }

        // Only send last 4 digits to backend
        hiddenInput.value = digits.slice(-4);

        // Validate expiry date
        const expiryInput = document.getElementById("expiry_date").value;
        const regex = /^(0[1-9]|1[0-2])\/\d{2}$/;

        if (!regex.test(expiryInput)) {
            alert("Invalid expiry date format. Use MM/YY.");
            e.preventDefault();
            return;
        }

        const [month, year] = expiryInput.split('/');
        const inputDate = new Date(`20${year}`, month - 1); // JS months are 0-indexed
        const currentDate = new Date();
        currentDate.setDate(1); // ignore day

        if (inputDate < currentDate) {
            alert("Expiry date cannot be in the past.");
            e.preventDefault();
            return;
        }
    });
</script>
{% endblock %}